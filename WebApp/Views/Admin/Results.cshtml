@model List<WebApp.ViewModels.StudentResultRowViewModel>
@{
    ViewData["Title"] = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã";
    var tasks  = ViewBag.Tasks as List<WebApp.Models.TestTask> ?? new();
    string? search = ViewBag.Search;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin/results.css" asp-append-version="true" />
}

<div class="admin-header">
    <div class="admin-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
    <form method="post" asp-action="Logout" asp-controller="Admin">
        <button class="logout-btn" type="submit">–í—ã–π—Ç–∏</button>
    </form>
</div>

<div class="stat-bar">
    <div class="stat-card">
        <div class="val">@Model.Count</div>
        <div class="lbl">–°—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="val">@tasks.Count</div>
        <div class="lbl">–ó–∞–¥–∞–Ω–∏–π</div>
    </div>
    @if (Model.Any())
    {
        <div class="stat-card">
            <div class="val">@Math.Round(Model.Average(r => r.TotalPoints), 1)</div>
            <div class="lbl">–°—Ä–µ–¥–Ω–∏–π –∏—Ç–æ–≥</div>
        </div>
    }
</div>

<form method="get" asp-action="Results" asp-controller="Admin" class="search-bar">
    <input type="text" name="search" value="@search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –§–ò–û –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" />
    <button type="submit" class="btn-search">–ù–∞–π—Ç–∏</button>
    <a href="/Admin/Results" class="btn-reset">–°–±—Ä–æ—Å–∏—Ç—å</a>
</form>

@if (!Model.Any())
{
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-text">–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    </div>
}
else
{
    <div class="table-wrap">
        <table class="results-table">
            <thead>
                <tr>
                    <th class="th-name">–°—Ç—É–¥–µ–Ω—Ç</th>
                    @foreach (var t in tasks)
                    {
                        <th>‚Ññ@t.Id</th>
                    }
                    <th>–ò—Ç–æ–≥–æ</th>
                    <th></th>
                </tr>
                <tr>
                    <th class="th-name th-subtitle">–§–ò–û (–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)</th>
                    @foreach (var t in tasks)
                    {
                        <th class="th-subtitle-task">@t.TitleRu</th>
                    }
                    <th class="th-subtitle">–±–∞–ª–ª–æ–≤</th>
                    <th class="th-subtitle"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model)
                {
                    <tr>
                        <td class="td-name">
                            <div class="td-name-text">@row.FullName</div>
                            <div class="org-hint">(@row.Organization)</div>
                        </td>
                        @foreach (var t in tasks)
                        {
                            <td class="score-cell">
                                @if (row.ScoreByTask.TryGetValue(t.Id, out int pts))
                                {
                                    <span class="score-yes">@pts</span>
                                }
                                else
                                {
                                    <span class="score-no">‚Äî</span>
                                }
                            </td>
                        }
                        <td class="score-total">@row.TotalPoints</td>
                        <td>
                            <a class="btn-details" href="/Admin/Details?participantId=@row.ParticipantId">
                                –î–µ—Ç–∞–ª–∏ ‚Üí
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
